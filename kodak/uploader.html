<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة طلبات المطعم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* الأساسيات */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f4f4f4;
            color: #333;
            direction: rtl;
            min-height: 100vh;
            padding: 10px;
        }
        
        /* العنوان */
        .header {
            background: linear-gradient(135deg, #e53935 0%, #b71c1c 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(229, 57, 53, 0.2);
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }
        
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .mute-btn, .enable-sound-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .mute-btn:hover, .enable-sound-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .enable-sound-btn.active {
            background: #43a047;
        }
        
        .network-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .network-status.connected {
            color: #4caf50;
        }
        
        .network-status.disconnected {
            color: #ff6b6b;
        }
        
        /* القائمة الجانبية */
        .sidebar {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100%;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            z-index: 1001;
            transition: right 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }
        
        .sidebar.active {
            right: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .sidebar-header h3 {
            color: #e53935;
            font-size: 20px;
        }
        
        .close-sidebar {
            background: #e53935;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .sidebar-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #e53935;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 20px;
        }
        
        /* الإشعارات */
        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            background: #43a047;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .notification i {
            font-size: 24px;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* تبويبات الطلبات */
        .tabs-container {
            display: flex;
            background: white;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: white;
            border: none;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #666;
        }
        
        .tab-btn.active {
            background: #e53935;
            color: white;
            box-shadow: 0 2px 8px rgba(229, 57, 53, 0.3);
        }
        
        .tab-btn .badge {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 14px;
            min-width: 30px;
        }
        
        .tab-btn:not(.active) .badge {
            background: #e53935;
            color: white;
        }
        
        /* قسم الطلبات */
        .orders-section {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s;
            display: none;
            height: calc(100vh - 250px);
            overflow: hidden;
            flex-direction: column;
        }
        
        .orders-section.active {
            display: flex;
        }
        
        .section-title {
            font-size: 22px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #eee;
            color: #e53935;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            background: #e53935;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* كروت الطلبات */
        .orders-container {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .orders-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .orders-container::-webkit-scrollbar-thumb {
            background: #e53935;
            border-radius: 10px;
        }
        
        .order-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
            border-right: 4px solid #e53935;
            transition: all 0.3s ease;
            border: 1px solid #eee;
            position: relative;
        }
        
        .order-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #eee;
        }
        
        .order-id {
            font-weight: bold;
            color: #e53935;
            font-size: 18px;
        }
        
        .order-type {
            background: #e53935;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .customer-info {
            margin-bottom: 12px;
        }
        
        .customer-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
            color: #333;
        }
        
        .customer-phone {
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .time-controls {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        .time-btn {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }
        
        .time-btn:hover {
            background: #e0e0e0;
        }
        
        .prep-time {
            background: #e53935;
            color: white;
            padding: 8px 15px;
            border-radius: 6px;
            margin: 12px 0;
            text-align: center;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .prep-time.overdue {
            background: #ff4444;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .arrival-time {
            color: #666;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .order-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-accept {
            background: #43a047;
            color: white;
        }
        
        .btn-reject {
            background: #e53935;
            color: white;
        }
        
        .btn-view {
            background: #2196f3;
            color: white;
        }
        
        .btn-print {
            background: #333;
            color: white;
        }
        
        .btn-ready {
            background: #43a047;
            color: white;
        }
        
        .btn-delete {
            background: #e53935;
            color: white;
        }
        
        .btn-received {
            background: #ff9800;
            color: white;
        }
        
        .btn-close {
            background: #666;
            color: white;
        }
        
        /* نافذة تفاصيل الطلب */
        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        
        .order-details-modal {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: modalAppear 0.4s ease-out;
        }
        
        @keyframes modalAppear {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #e53935 0%, #b71c1c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .details-card {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #e53935;
        }
        
        .details-card h3 {
            color: #e53935;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .detail-label {
            font-weight: bold;
            color: #555;
        }
        
        .detail-value {
            color: #333;
            text-align: left;
            max-width: 200px;
            word-break: break-word;
        }
        
        .items-list {
            margin-top: 20px;
        }
        
        .items-list h3 {
            color: #e53935;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        
        .item-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            margin-bottom: 8px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        .item-info {
            flex: 2;
        }
        
        .item-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .item-note {
            color: #666;
            font-size: 14px;
            font-style: italic;
        }
        
        .item-qty {
            flex: 1;
            text-align: center;
            font-weight: bold;
            color: #e53935;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        /* زر التصدير في السايدبار */
        .sidebar-btn {
            background: linear-gradient(135deg, #43a047 0%, #2e7d32 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            width: 100%;
        }
        
        .sidebar-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(67, 160, 71, 0.3);
        }
        
        /* زر حذف الكل في السايدبار */
        .sidebar-delete-btn {
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s;
            width: 100%;
        }
        
        .sidebar-delete-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 68, 68, 0.3);
        }
        
        /* تذييل الصفحة */
        .footer {
            text-align: center;
            margin-top: 20px;
            color: #666;
            padding-top: 15px;
            border-top: 1px solid #ddd;
            font-size: 14px;
        }
        
        /* طباعة الفاتورة الحرارية */
        @media print {
            body * {
                visibility: hidden;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            #receipt, #receipt * {
                visibility: visible !important;
            }
            
            #receipt {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 80mm !important;
                min-width: 80mm !important;
                max-width: 80mm !important;
                height: auto !important;
                padding: 5mm !important;
                font-size: 10pt !important;
                box-sizing: border-box !important;
                background: white !important;
                color: black !important;
                border: none !important;
                box-shadow: none !important;
                margin: 0 !important;
                transform: none !important;
                font-family: 'Courier New', monospace !important;
                line-height: 1.2 !important;
                overflow: visible !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            .receipt-header {
                text-align: center;
                margin-bottom: 8px;
                border-bottom: 1px dashed #000;
                padding-bottom: 8px;
            }
            
            .receipt-header h2 {
                font-size: 14pt;
                margin: 0;
                color: black;
            }
            
            .receipt-info {
                font-size: 9pt;
                margin: 8px 0;
            }
            
            .receipt-items table {
                width: 100%;
                border-collapse: collapse;
                margin: 10px 0;
                font-size: 9pt;
            }
            
            .receipt-items th, .receipt-items td {
                padding: 3px 0;
                text-align: right;
                border-bottom: 1px dashed #ccc;
            }
            
            .receipt-total {
                font-weight: bold;
                font-size: 11pt;
                text-align: center;
                margin-top: 15px;
                padding-top: 10px;
                border-top: 2px solid #000;
            }
            
            .receipt-footer {
                text-align: center;
                margin-top: 15px;
                font-size: 8pt;
                color: #666;
            }
            
            /* تحسين جدول المنتجات في الطباعة */
            .receipt-items th {
                border-bottom: 2px solid #000;
                padding-bottom: 5px;
            }
            
            .receipt-items td {
                padding: 4px 0;
            }
        }
        
        /* التجاوب مع الشاشات المربعة وأجهزة POS */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            body {
                padding: 10px;
                max-height: 100vh;
                overflow: hidden;
            }
            
            .header {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .orders-section {
                height: calc(100vh - 200px);
                padding: 12px;
            }
            
            .orders-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 12px;
                overflow-y: auto;
            }
            
            .order-card {
                min-height: auto;
            }
            
            .order-buttons {
                flex-wrap: nowrap;
            }
            
            .btn {
                padding: 8px 10px;
                font-size: 13px;
            }
            
            .sidebar-toggle {
                top: 15px;
                right: 15px;
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
            
            .sidebar {
                width: 350px;
            }
        }
        
        /* التجاوب مع الشاشات الصغيرة */
        @media (max-width: 767px) {
            body {
                padding: 8px;
            }
            
            .header {
                padding: 12px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .header-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .tabs-container {
                margin-bottom: 15px;
            }
            
            .tab-btn {
                padding: 12px 8px;
                font-size: 16px;
            }
            
            .orders-section {
                height: calc(100vh - 220px);
                padding: 12px;
            }
            
            .order-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .sidebar {
                width: 100%;
                right: -100%;
            }
            
            .sidebar-toggle {
                top: 15px;
                right: 15px;
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 18px;
            }
            
            .tab-btn {
                font-size: 14px;
                padding: 10px 5px;
            }
            
            .btn {
                padding: 8px;
                font-size: 12px;
            }
            
            .order-card {
                padding: 12px;
            }
            
            .orders-container {
                gap: 10px;
            }
        }
        
        /* رسوم متحركة للطلبات الجديدة */
        @keyframes newOrder {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .new-order {
            animation: newOrder 0.5s ease-out;
        }
        
        /* فلتر البحث في السايدبار */
        .sidebar-search-filter {
            margin-bottom: 15px;
            padding: 12px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .date-range {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .date-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            flex: 1;
            min-width: 120px;
        }
        
        /* حالة الطلب */
        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .status-pending {
            background: #ff9800;
            color: white;
        }
        
        .status-accepted {
            background: #2196f3;
            color: white;
        }
        
        .status-ready {
            background: #4caf50;
            color: white;
        }
        
        .status-received {
            background: #9c27b0;
            color: white;
        }
        
        .status-overdue {
            background: #f44336;
            color: white;
            animation: blink 1s infinite;
        }
        
        /* تحسينات للفاتورة في الشاشة */
        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .receipt-table th {
            text-align: right;
            border-bottom: 2px solid #000;
            padding: 8px 0;
            font-weight: bold;
        }
        
        .receipt-table td {
            text-align: right;
            border-bottom: 1px dashed #ccc;
            padding: 6px 0;
        }
        
        .receipt-table .item-note-cell {
            font-size: 10px;
            color: #666;
            font-style: italic;
        }
        
        /* تحسينات إضافية */
        .order-stats {
            display: flex;
            gap: 12px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .stat-value {
            font-weight: bold;
            color: #e53935;
        }
        
        /* تحسينات للأزرار */
        .btn-sm {
            padding: 6px 10px;
            font-size: 12px;
        }
        
        /* تحسينات للوقت */
        .time-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #333;
        }
        
        /* حالة عدم وجود طلبات */
        .no-orders {
            text-align: center;
            padding: 40px 20px;
            color: #666;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .no-orders i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        .no-orders h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .no-orders p {
            font-size: 14px;
        }
        
        /* تحسينات لأجهزة الشاشات الصغيرة جداً */
        @media (max-width: 360px) {
            .header-controls > div {
                width: 100%;
            }
            
            .tab-btn {
                font-size: 12px;
            }
            
            .order-id {
                font-size: 16px;
            }
            
            .customer-name {
                font-size: 16px;
            }
        }
        
        /* قائمة الطلبات السابقة في السايدبار */
        .sidebar-orders-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            background: #fafafa;
        }
        
        .sidebar-orders-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .sidebar-orders-container::-webkit-scrollbar-thumb {
            background: #e53935;
            border-radius: 10px;
        }
        
        .sidebar-order-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #eee;
            border-right: 3px solid #e53935;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .sidebar-order-item:hover {
            background: #f5f5f5;
            transform: translateX(-3px);
        }
        
        .sidebar-order-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .sidebar-order-id {
            font-weight: bold;
            color: #e53935;
        }
        
        .sidebar-order-status {
            font-size: 11px;
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .sidebar-order-status.received {
            background: #9c27b0;
        }
        
        .sidebar-order-customer {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .sidebar-order-date {
            font-size: 12px;
            color: #666;
        }
        
        .sidebar-section-title {
            font-size: 16px;
            color: #e53935;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar-section-title i {
            color: #e53935;
        }
        
        .sidebar-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .sidebar-controls .btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <!-- إشعار الطلب الجديد -->
    <div class="notification" id="notification">
        <i class="fas fa-bell"></i>
        <div>
            <strong>طلب جديد!</strong>
            <p>تم استلام طلب جديد في النظام</p>
        </div>
    </div>
    
    <!-- زر فتح القائمة الجانبية -->
    <button class="sidebar-toggle no-print" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- القائمة الجانبية -->
    <div class="sidebar no-print" id="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-cog"></i> الإعدادات والأدوات</h3>
            <button class="close-sidebar" id="closeSidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="sidebar-content">
            <!-- البحث والتصفية -->
            <div class="sidebar-search-filter">
                <h4 class="sidebar-section-title">
                    <i class="fas fa-search"></i> البحث والتصفية
                </h4>
                <input type="text" class="search-input" id="sidebarSearchInput" placeholder="بحث باسم العميل أو رقم الهاتف...">
                <div class="date-range">
                    <input type="date" class="date-input" id="sidebarStartDate">
                    <input type="date" class="date-input" id="sidebarEndDate">
                </div>
                <div class="sidebar-controls">
                    <button class="btn btn-view" id="sidebarFilterBtn">
                        <i class="fas fa-filter"></i> تصفية
                    </button>
                    <button class="btn btn-close" id="sidebarClearFilterBtn">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </div>
            
            <!-- الطلبات السابقة -->
            <div>
                <h4 class="sidebar-section-title">
                    <i class="fas fa-history"></i> الطلبات السابقة
                    <span style="font-size: 12px; background: #e53935; color: white; padding: 2px 8px; border-radius: 10px;" id="sidebarReceivedCount">0</span>
                </h4>
                <div class="sidebar-orders-container" id="sidebarReceivedOrders">
                    <div class="no-orders" style="padding: 20px;">
                        <i class="fas fa-history"></i>
                        <h3 style="font-size: 14px;">لا توجد طلبات سابقة</h3>
                    </div>
                </div>
                <div class="sidebar-controls">
                    <button class="sidebar-btn" id="sidebarExportBtn">
                        <i class="fas fa-file-excel"></i> تصدير Excel
                    </button>
                    <button class="sidebar-delete-btn" id="sidebarDeleteAllBtn">
                        <i class="fas fa-trash-alt"></i> حذف الكل
                    </button>
                </div>
            </div>
            
            <!-- الإعدادات -->
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                <h4 style="color: #e53935; margin-bottom: 10px;">تعليمات:</h4>
                <p style="font-size: 14px; color: #666; line-height: 1.5;">
                    - تصدير Excel: يقوم بتصدير جميع الطلبات ضمن النطاق الزمني المحدد في الفلتر
                    <br><br>
                    - حذف جميع الطلبات: يحتاج إلى كلمة مرور للتنفيذ (121212)
                </p>
            </div>
        </div>
    </div>
    
    <!-- الرأس -->
    <header class="header no-print">
        <h1><i class="fas fa-utensils"></i> نظام إدارة طلبات المطعم</h1>
        <p>إدارة وتنظيم الطلبات الواردة من العملاء</p>
        
        <div class="header-controls">
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <button class="enable-sound-btn" id="enableSoundBtn">
                    <i class="fas fa-volume-up"></i> تمكين صوت الإشعارات
                </button>
                <button class="mute-btn" id="muteBtn" style="display: none;">
                    <i class="fas fa-volume-mute"></i> كتم الصوت
                </button>
                <div class="network-status" id="networkStatus">
                    <i class="fas fa-wifi"></i> جاري الاتصال...
                </div>
            </div>
        </div>
    </header>
    
    <!-- تبويبات الطلبات -->
    <div class="tabs-container no-print">
        <button class="tab-btn active" id="newOrdersTab" onclick="switchTab('new')">
            <i class="fas fa-clock"></i>
            الطلبات الجديدة
            <span class="badge" id="newOrdersTabCount">0</span>
        </button>
        <button class="tab-btn" id="acceptedOrdersTab" onclick="switchTab('accepted')">
            <i class="fas fa-check-circle"></i>
            الطلبات المقبولة
            <span class="badge" id="acceptedOrdersTabCount">0</span>
        </button>
        <button class="tab-btn" id="readyOrdersTab" onclick="switchTab('ready')">
            <i class="fas fa-check-double"></i>
            الطلبات الجاهزة
            <span class="badge" id="readyOrdersTabCount">0</span>
        </button>
    </div>
    
    <!-- أقسام الطلبات -->
    <section class="orders-section active" id="newOrdersSection">
        <h2 class="section-title">
            <i class="fas fa-clock"></i>
            الطلبات الجديدة
        </h2>
        <div class="orders-container" id="newOrders">
            <div class="no-orders">
                <i class="fas fa-inbox"></i>
                <h3>لا توجد طلبات جديدة</h3>
                <p>في انتظار وصول الطلبات الجديدة...</p>
            </div>
        </div>
    </section>
    
    <section class="orders-section" id="acceptedOrdersSection">
        <h2 class="section-title">
            <i class="fas fa-check-circle"></i>
            الطلبات المقبولة
        </h2>
        <div class="orders-container" id="acceptedOrders">
            <div class="no-orders">
                <i class="fas fa-clipboard-check"></i>
                <h3>لا توجد طلبات مقبولة</h3>
                <p>سيظهر هنا الطلبات التي تم قبولها...</p>
            </div>
        </div>
    </section>
    
    <section class="orders-section" id="readyOrdersSection">
        <h2 class="section-title">
            <i class="fas fa-check-double"></i>
            الطلبات الجاهزة
        </h2>
        <div class="orders-container" id="readyOrders">
            <div class="no-orders">
                <i class="fas fa-check-double"></i>
                <h3>لا توجد طلبات جاهزة</h3>
                <p>سيظهر هنا الطلبات التي أصبحت جاهزة...</p>
            </div>
        </div>
    </section>
    
    <!-- نافذة تفاصيل الطلب -->
    <div class="modal-overlay no-print" id="orderDetailsModal">
        <div class="order-details-modal">
            <div class="modal-header">
                <h2 class="modal-title"><i class="fas fa-receipt"></i> تفاصيل الطلب</h2>
                <button class="close-modal" id="closeModalBtn">&times;</button>
            </div>
            
            <div class="modal-body" id="orderDetailsBody">
                <!-- سيتم تعبئة تفاصيل الطلب هنا ديناميكياً -->
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-print" id="printReceiptBtn">
                    <i class="fas fa-print"></i> طباعة الفاتورة
                </button>
                <button class="btn btn-close" id="closeDetailsBtn">
                    <i class="fas fa-times"></i> إغلاق
                </button>
            </div>
        </div>
    </div>
    
    <!-- تذييل الصفحة -->
    <footer class="footer no-print">
        <p>© 2023 نظام إدارة طلبات المطعم | تم التطوير بواسطة فريق التطوير</p>
    </footer>
    
    <!-- فاتورة الطباعة (مخفية) -->
    <div id="receipt" style="display: none; width: 80mm; padding: 10px; background: white; font-family: 'Courier New', monospace; line-height: 1.2;">
        <div class="receipt-header">
            <h2 style="margin: 0; font-size: 16pt;">فرع الرابية</h2>
            <p style="margin: 2px 0; font-size: 10pt;">  </p>
            <p style="margin: 2px 0; font-size: 10pt;">هاتف: 0797766055</p>
        </div>
        
        <div class="receipt-info">
            <p id="receiptOrderId" style="margin: 3px 0; font-size: 10pt;">الطلب: #20454</p>
            <p id="receiptDate" style="margin: 3px 0; font-size: 10pt;">التاريخ: 12/12/2023 10:30</p>
            <hr style="border: none; border-top: 1px dashed #000; margin: 8px 0;">
        </div>
        
        <div class="customer-info">
            <p id="receiptCustomerName" style="margin: 3px 0; font-size: 10pt;">العميل: محمد سعيد</p>
            <p id="receiptCustomerPhone" style="margin: 3px 0; font-size: 10pt;">الهاتف: 0778715612</p>
            <p id="receiptPickupType" style="margin: 3px 0; font-size: 10pt; font-weight: bold;">استلام</p>
            <p id="receiptPayment" style="margin: 3px 0; font-size: 10pt;">الدفع: كاش</p>
        </div>
        
        <hr style="border: none; border-top: 1px dashed #000; margin: 8px 0;">
        
        <div class="receipt-items">
            <table class="receipt-table">
                <thead>
                    <tr>
                        <th style="width: 70%;">المنتج</th>
                        <th style="width: 30%; text-align: center;">الكمية</th>
                    </tr>
                </thead>
                <tbody id="receiptItemsBody">
                    <!-- سيتم إضافة المنتجات هنا -->
                </tbody>
            </table>
        </div>
        
        <div class="receipt-total">
            <p id="receiptTotal" style="font-weight: bold; font-size: 12pt; text-align: center; margin: 10px 0;">الإجمالي: 4.50 دينار</p>
        </div>
        
        <div class="receipt-footer">
            <p style="margin: 5px 0; font-size: 9pt;"></p>
            <p style="margin: 5px 0; font-size: 9pt;"></p>
            <p style="margin: 5px 0; font-size: 8pt; color: #666;">تاريخ الطباعة: <span id="receiptPrintDate"></span></p>
        </div>
    </div>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAOhgRpF5YZ5fochZrmTniCtK4ScUnAsx0",
            authDomain: "all-in-one-testing.firebaseapp.com",
            databaseURL: "https://all-in-one-testing-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "all-in-one-testing",
            storageBucket: "all-in-one-testing.firebasestorage.app",
            messagingSenderId: "1020817144764",
            appId: "1:1020817144764:web:79999a783418c2b3e309b9",
            measurementId: "G-BV2GP93MKN"
        };
        
        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // المتغيرات العامة
        let allOrders = [];
        let currentOrder = null;
        let soundEnabled = localStorage.getItem('soundEnabled') === 'true' || false;
        let audioContext = null;
        let audioBuffer = null;
        let repeatSoundInterval = null;
        let pendingOrdersToAlert = new Set();
        let countdownIntervals = {};
        let currentTab = 'new'; // التبويب الحالي
        
        // عناصر DOM
        const newOrdersContainer = document.getElementById('newOrders');
        const acceptedOrdersContainer = document.getElementById('acceptedOrders');
        const readyOrdersContainer = document.getElementById('readyOrders');
        const newOrdersSection = document.getElementById('newOrdersSection');
        const acceptedOrdersSection = document.getElementById('acceptedOrdersSection');
        const readyOrdersSection = document.getElementById('readyOrdersSection');
        const newOrdersTab = document.getElementById('newOrdersTab');
        const acceptedOrdersTab = document.getElementById('acceptedOrdersTab');
        const readyOrdersTab = document.getElementById('readyOrdersTab');
        const newOrdersTabCount = document.getElementById('newOrdersTabCount');
        const acceptedOrdersTabCount = document.getElementById('acceptedOrdersTabCount');
        const readyOrdersTabCount = document.getElementById('readyOrdersTabCount');
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const orderDetailsBody = document.getElementById('orderDetailsBody');
        const notification = document.getElementById('notification');
        const enableSoundBtn = document.getElementById('enableSoundBtn');
        const muteBtn = document.getElementById('muteBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeDetailsBtn = document.getElementById('closeDetailsBtn');
        const printReceiptBtn = document.getElementById('printReceiptBtn');
        const networkStatus = document.getElementById('networkStatus');
        
        // عناصر القائمة الجانبية
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const closeSidebar = document.getElementById('closeSidebar');
        const sidebarSearchInput = document.getElementById('sidebarSearchInput');
        const sidebarStartDate = document.getElementById('sidebarStartDate');
        const sidebarEndDate = document.getElementById('sidebarEndDate');
        const sidebarFilterBtn = document.getElementById('sidebarFilterBtn');
        const sidebarClearFilterBtn = document.getElementById('sidebarClearFilterBtn');
        const sidebarReceivedOrders = document.getElementById('sidebarReceivedOrders');
        const sidebarReceivedCount = document.getElementById('sidebarReceivedCount');
        const sidebarExportBtn = document.getElementById('sidebarExportBtn');
        const sidebarDeleteAllBtn = document.getElementById('sidebarDeleteAllBtn');
        
        // تهيئة التواريخ في القائمة الجانبية
        const today = new Date();
        const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        sidebarStartDate.valueAsDate = lastWeek;
        sidebarEndDate.valueAsDate = today;
        
        // صوت التنبيه
        const alertSound = new Audio('./sounds/alert.mp3');
        alertSound.preload = "auto";
        alertSound.volume = 0.7;
        
        // إدارة القائمة الجانبية
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.add('active');
            loadSidebarReceivedOrders(); // تحميل الطلبات السابقة عند فتح القائمة
        });
        
        closeSidebar.addEventListener('click', () => {
            sidebar.classList.remove('active');
        });
        
        // إغلاق القائمة الجانبية عند النقر خارجها
        document.addEventListener('click', (e) => {
            if (!sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
                sidebar.classList.remove('active');
            }
        });
        
        // تبديل التبويبات
        function switchTab(tab) {
            currentTab = tab;
            
            // تحديث الأزرار
            newOrdersTab.classList.remove('active');
            acceptedOrdersTab.classList.remove('active');
            readyOrdersTab.classList.remove('active');
            
            // إخفاء جميع الأقسام
            newOrdersSection.classList.remove('active');
            acceptedOrdersSection.classList.remove('active');
            readyOrdersSection.classList.remove('active');
            
            if (tab === 'new') {
                newOrdersTab.classList.add('active');
                newOrdersSection.classList.add('active');
            } else if (tab === 'accepted') {
                acceptedOrdersTab.classList.add('active');
                acceptedOrdersSection.classList.add('active');
            } else {
                readyOrdersTab.classList.add('active');
                readyOrdersSection.classList.add('active');
            }
        }
        
        // تهيئة Web Audio API
        function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                loadAudioBuffer();
            } catch (e) {
                console.warn('Web Audio API غير متاح:', e);
            }
        }
        
        async function loadAudioBuffer() {
            try {
                const response = await fetch('./sounds/alert.mp3');
                const arrayBuffer = await response.arrayBuffer();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
            } catch (e) {
                console.warn('فشل تحميل الصوت:', e);
            }
        }
        
        // تشغيل الصوت مع fallback
        async function playAlertSound() {
            if (!soundEnabled) return;
            
            try {
                alertSound.currentTime = 0;
                await alertSound.play();
                return true;
            } catch (err) {
                console.log('فشل تشغيل الصوت المباشر، جاري تجربة Web Audio API...');
                
                if (audioContext && audioBuffer) {
                    try {
                        const source = audioContext.createBufferSource();
                        source.buffer = audioBuffer;
                        source.connect(audioContext.destination);
                        source.start(0);
                        return true;
                    } catch (e) {
                        console.warn('فشل Web Audio API:', e);
                    }
                }
                
                showMessage('يجب تمكين الصوت يدوياً. اضغط على زر "تمكين صوت الإشعارات"', 'error');
                return false;
            }
        }
        
        // تكرار صوت التنبيه للطلبات المنتظرة - تم التعديل ليصبح كل 2 ثانية
        function startRepeatSoundForOrder(orderKey) {
            if (!soundEnabled) return;
            
            pendingOrdersToAlert.add(orderKey);
            
            if (repeatSoundInterval) return;
            
            repeatSoundInterval = setInterval(async () => {
                if (pendingOrdersToAlert.size > 0 && soundEnabled) {
                    await playAlertSound();
                }
            }, 1000); // كل 2 ثواني (تم التعديل من 8000 إلى 2000)
        }
        
        function stopRepeatSoundForOrder(orderKey) {
            pendingOrdersToAlert.delete(orderKey);
            
            if (pendingOrdersToAlert.size === 0 && repeatSoundInterval) {
                clearInterval(repeatSoundInterval);
                repeatSoundInterval = null;
            }
        }
        
        // إدارة الصوت
        function updateSoundUI() {
            if (soundEnabled) {
                enableSoundBtn.style.display = 'none';
                muteBtn.style.display = 'flex';
                enableSoundBtn.classList.remove('active');
                localStorage.setItem('soundEnabled', 'true');
            } else {
                enableSoundBtn.style.display = 'flex';
                muteBtn.style.display = 'none';
                localStorage.setItem('soundEnabled', 'false');
            }
        }
        
        enableSoundBtn.addEventListener('click', () => {
            soundEnabled = true;
            updateSoundUI();
            showMessage('تم تمكين صوت الإشعارات', 'success');
            playAlertSound();
        });
        
        muteBtn.addEventListener('click', () => {
            soundEnabled = false;
            updateSoundUI();
            showMessage('تم كتم صوت الإشعارات', 'success');
            
            // إيقاف التكرار
            if (repeatSoundInterval) {
                clearInterval(repeatSoundInterval);
                repeatSoundInterval = null;
            }
            pendingOrdersToAlert.clear();
        });
        
        // تحديث حالة الشبكة
        function updateNetworkStatus(connected) {
            if (connected) {
                networkStatus.innerHTML = '<i class="fas fa-wifi"></i> متصل';
                networkStatus.className = 'network-status connected';
            } else {
                networkStatus.innerHTML = '<i class="fas fa-wifi-slash"></i> غير متصل';
                networkStatus.className = 'network-status disconnected';
            }
        }
        
        // مراقبة حالة الاتصال
        const connectedRef = database.ref(".info/connected");
        connectedRef.on("value", function(snap) {
            updateNetworkStatus(snap.val() === true);
        });
        
        // إظهار الإشعار
        async function showNotification(orderKey) {
            notification.style.display = 'flex';
            
            // تشغيل الصوت
            await playAlertSound();
            
            // بدء تكرار الصوت للطلب الجديد
            startRepeatSoundForOrder(orderKey);
            
            // إخفاء الإشعار بعد 5 ثواني
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // تنسيق التاريخ
        function formatDate(timestamp) {
            if (!timestamp) return 'غير محدد';
            
            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    const parsedTimestamp = parseInt(timestamp);
                    if (!isNaN(parsedTimestamp)) {
                        const newDate = new Date(parsedTimestamp);
                        if (!isNaN(newDate.getTime())) {
                            return newDate.toLocaleString('ar-EG', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    }
                    return 'غير محدد';
                }
                
                return date.toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (e) {
                console.error('خطأ في تنسيق التاريخ:', e);
                return 'غير محدد';
            }
        }
        
        // تنسيق التاريخ للطباعة
        function formatDateForPrint(timestamp) {
            if (!timestamp) return 'غير محدد';
            
            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    const parsedTimestamp = parseInt(timestamp);
                    if (!isNaN(parsedTimestamp)) {
                        const newDate = new Date(parsedTimestamp);
                        if (!isNaN(newDate.getTime())) {
                            return newDate.toLocaleString('ar-EG', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    }
                    return 'غير محدد';
                }
                
                return date.toLocaleString('ar-EG', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                console.error('خطأ في تنسيق التاريخ للطباعة:', e);
                return 'غير محدد';
            }
        }
        
        // حساب الوقت المتبقي
        function getTimeRemaining(order) {
            try {
                if (!order || !order.prepTime) return order?.prepTime || 15;
                
                const orderDate = new Date(order.timestamp);
                const acceptedAt = order.acceptedAt ? new Date(order.acceptedAt) : orderDate;
                
                if (isNaN(acceptedAt.getTime())) {
                    return order.prepTime || 15;
                }
                
                const addedMinutes = order.addedMinutes || 0;
                const totalPrepTime = (parseInt(order.prepTime) || 15) + parseInt(addedMinutes);
                
                const now = new Date();
                const diffMs = now - acceptedAt;
                const diffMins = Math.floor(diffMs / 60000);
                const minutesLeft = totalPrepTime - diffMins;
                
                if (isNaN(minutesLeft)) {
                    return totalPrepTime;
                }
                
                return Math.max(0, minutesLeft);
            } catch (e) {
                console.error('خطأ في حساب الوقت المتبقي:', e);
                return order?.prepTime || 15;
            }
        }
        
        // إنشاء كارت طلب جديد
        function createOrderCard(order, isNew = true) {
            try {
                const orderType = order.orderType === 'توصيل' ? 'توصيل' : 'استلام';
                const prepTime = parseInt(order.prepTime) || 15;
                const addedMinutes = parseInt(order.addedMinutes) || 0;
                const totalPrepTime = prepTime + addedMinutes;
                
                const card = document.createElement('div');
                card.className = 'order-card new-order';
                card.dataset.key = order.key;
                
                // تحديد لون الحالة
                let statusClass = 'status-pending';
                let statusText = 'قيد الانتظار';
                
                if (order.status === 'accepted') {
                    statusClass = 'status-accepted';
                    statusText = 'مقبول';
                } else if (order.status === 'ready') {
                    statusClass = 'status-ready';
                    statusText = 'جاهز';
                } else if (order.status === 'received') {
                    statusClass = 'status-received';
                    statusText = 'تم الاستلام';
                } else if (order.status === 'deleted' || order.status === 'cancelled') {
                    statusClass = 'status-overdue';
                    statusText = 'ملغي';
                } else if (order.overdue) {
                    statusClass = 'status-overdue';
                    statusText = 'متأخر';
                }
                
                // حساب الوقت المتبقي
                const timeRemaining = getTimeRemaining(order);
                const isOverdue = timeRemaining !== null && timeRemaining <= 0 && order.status === 'accepted';
                
                // نص وقت التحضير (يظهر فقط إذا لم يكن الطلب جاهزاً)
                let prepTimeText = '';
                if (order.status !== 'ready' && order.status !== 'received') {
                    if (typeof timeRemaining === 'number' && !isNaN(timeRemaining)) {
                        if (timeRemaining <= 0 && order.status === 'accepted') {
                            prepTimeText = `تأخر: ${Math.abs(timeRemaining)} دقيقة`;
                        } else {
                            prepTimeText = `الوقت المتبقي: ${timeRemaining} دقيقة`;
                        }
                    } else {
                        prepTimeText = `التحضير: ${totalPrepTime} دقيقة`;
                    }
                    
                    // إضافة الإضافات إذا وجدت
                    if (addedMinutes > 0) {
                        prepTimeText += ` (+${addedMinutes})`;
                    }
                }
                
                card.innerHTML = `
                    <div class="order-header">
                        <span class="order-id">#${order.id || order.key.substring(0, 6)}</span>
                        <div>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            ${orderType === 'توصيل' ? '' : `<span class="order-type">${orderType}</span>`}
                        </div>
                    </div>
                    
                    <div class="customer-info">
                        <div class="customer-name">${order.customerName || 'غير معروف'}</div>
                        <div class="customer-phone">
                            <i class="fas fa-phone"></i>
                            ${order.customerPhone || 'لا يوجد'}
                        </div>
                    </div>
                    
                    ${order.deliveryArea && orderType === 'توصيل' ? `
                    <div class="arrival-time">
                        <i class="fas fa-map-marker-alt"></i>
                        ${order.deliveryArea}
                    </div>
                    ` : ''}
                    
                    ${isNew && !['deleted', 'cancelled', 'ready', 'received'].includes(order.status) ? `
                    <div class="time-controls">
                        <button class="time-btn" onclick="addExtraTime('${order.key}', 5)">+5 دقائق</button>
                        <button class="time-btn" onclick="addExtraTime('${order.key}', 10)">+10 دقائق</button>
                        <button class="time-btn" onclick="addExtraTime('${order.key}', 15)">+15 دقائق</button>
                    </div>
                    ` : ''}
                    
                    ${order.status !== 'ready' && order.status !== 'received' && !['deleted', 'cancelled'].includes(order.status) ? `
                    <div class="prep-time ${isOverdue ? 'overdue' : ''}">
                        <i class="fas fa-clock"></i>
                        ${prepTimeText}
                    </div>
                    ` : ''}
                    
                    <div class="arrival-time">
                        <i class="fas fa-calendar-alt"></i>
                        ${order.acceptedAt ? 'تم القبول: ' + formatDate(order.acceptedAt) : 'الطلب: ' + formatDate(order.timestamp)}
                    </div>
                    
                    <div class="order-buttons">
                        ${isNew && !['deleted', 'cancelled', 'ready', 'received'].includes(order.status) ? `
                        <button class="btn btn-accept" onclick="acceptOrder('${order.key}')">
                            <i class="fas fa-check"></i> قبول
                        </button>
                        <button class="btn btn-reject" onclick="rejectOrder('${order.key}')">
                            <i class="fas fa-times"></i> رفض
                        </button>
                        ` : ''}
                        
                        ${!isNew && order.status === 'accepted' && !['deleted', 'cancelled', 'ready', 'received'].includes(order.status) ? `
                        <button class="btn btn-ready" onclick="markAsReady('${order.key}')">
                            <i class="fas fa-check-double"></i> طلب جاهز
                        </button>
                        ` : ''}
                        
                        ${!isNew && order.status === 'ready' && !['deleted', 'cancelled', 'received'].includes(order.status) ? `
                        <button class="btn btn-received" onclick="markAsReceived('${order.key}')">
                            <i class="fas fa-check-square"></i> تم الاستلام
                        </button>
                        ` : ''}
                        
                        ${!['deleted', 'cancelled'].includes(order.status) ? `
                        <button class="btn btn-view" onclick="viewOrderDetails('${order.key}')">
                            <i class="fas fa-eye"></i> عرض
                        </button>
                        ` : ''}
                        
                        ${!['deleted', 'cancelled'].includes(order.status) ? `
                        <button class="btn btn-print" onclick="printOrder('${order.key}')">
                            <i class="fas fa-print"></i> طباعة
                        </button>
                        ` : ''}
                        
                        ${!isNew && !['deleted', 'cancelled', 'received'].includes(order.status) ? `
                        <button class="btn btn-delete" onclick="deleteOrder('${order.key}')">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                        ` : ''}
                        
                        ${['deleted', 'cancelled'].includes(order.status) ? `
                        <button class="btn btn-delete" onclick="permanentDeleteOrder('${order.key}')">
                            <i class="fas fa-trash-alt"></i> حذف نهائي
                        </button>
                        ` : ''}
                    </div>
                `;
                
                return card;
            } catch (e) {
                console.error('خطأ في إنشاء كارت الطلب:', e);
                const errorCard = document.createElement('div');
                errorCard.className = 'order-card';
                errorCard.innerHTML = `
                    <div class="order-header">
                        <span class="order-id">#خطأ</span>
                    </div>
                    <div style="color: #e53935; text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>خطأ في تحميل بيانات الطلب</p>
                    </div>
                `;
                return errorCard;
            }
        }
        
        // إنشاء عنصر طلب للقائمة الجانبية
        function createSidebarOrderItem(order) {
            const item = document.createElement('div');
            item.className = 'sidebar-order-item';
            item.dataset.key = order.key;
            item.onclick = () => viewOrderDetails(order.key);
            
            const statusClass = order.status === 'received' ? 'received' : '';
            const statusText = order.status === 'received' ? 'تم الاستلام' : 'جاهز';
            
            item.innerHTML = `
                <div class="sidebar-order-header">
                    <span class="sidebar-order-id">#${order.id || order.key.substring(0, 6)}</span>
                    <span class="sidebar-order-status ${statusClass}">${statusText}</span>
                </div>
                <div class="sidebar-order-customer">${order.customerName || 'غير معروف'}</div>
                <div class="sidebar-order-date">${formatDate(order.timestamp)}</div>
            `;
            
            return item;
        }
        
        // تحميل الطلبات السابقة في القائمة الجانبية
        function loadSidebarReceivedOrders() {
            const receivedOrders = allOrders.filter(o => 
                o.status && 
                ['received'].includes(o.status) &&
                o.status !== 'deleted' && 
                o.status !== 'cancelled'
            );
            
            sidebarReceivedCount.textContent = receivedOrders.length;
            
            if (receivedOrders.length === 0) {
                sidebarReceivedOrders.innerHTML = `
                    <div class="no-orders" style="padding: 20px;">
                        <i class="fas fa-history"></i>
                        <h3 style="font-size: 14px;">لا توجد طلبات سابقة</h3>
                    </div>
                `;
                return;
            }
            
            // فرز الطلبات حسب التاريخ (الأحدث أولاً)
            receivedOrders.sort((a, b) => b.timestamp - a.timestamp);
            
            const fragment = document.createDocumentFragment();
            receivedOrders.forEach(order => {
                const item = createSidebarOrderItem(order);
                fragment.appendChild(item);
            });
            
            sidebarReceivedOrders.innerHTML = '';
            sidebarReceivedOrders.appendChild(fragment);
        }
        
        // تصفية البحث في القائمة الجانبية
        function sidebarFilterOrders() {
            const searchTerm = sidebarSearchInput.value.toLowerCase();
            const startTS = sidebarStartDate.value ? new Date(sidebarStartDate.value).getTime() : null;
            const endTS = sidebarEndDate.value ? new Date(sidebarEndDate.value).getTime() + 24 * 60 * 60 * 1000 - 1 : null;
            
            updateOrdersUI(searchTerm, startTS, endTS);
            
            // تحديث الطلبات السابقة في القائمة الجانبية أيضًا
            loadSidebarReceivedOrders();
        }
        
        // إضافة وقت إضافي
        function addExtraTime(orderKey, minutes) {
            const orderRef = database.ref('orders/' + orderKey);
            orderRef.transaction(currentOrder => {
                if (currentOrder) {
                    currentOrder.addedMinutes = (parseInt(currentOrder.addedMinutes) || 0) + parseInt(minutes);
                    if (!currentOrder.history) currentOrder.history = [];
                    currentOrder.history.push({
                        action: 'add_time',
                        minutes: minutes,
                        by: 'manager',
                        time: Date.now()
                    });
                }
                return currentOrder;
            }).then(() => {
                showMessage(`تم إضافة ${minutes} دقيقة للطلب`, 'success');
            }).catch(error => {
                showMessage('حدث خطأ أثناء إضافة الوقت: ' + error.message, 'error');
            });
        }
        
        // بدء العد التنازلي
        function startCountdown(orderKey, order) {
            if (order.status !== 'accepted' || countdownIntervals[orderKey]) return;
            
            countdownIntervals[orderKey] = setInterval(() => {
                const orderIndex = allOrders.findIndex(o => o.key === orderKey);
                if (orderIndex === -1) {
                    clearInterval(countdownIntervals[orderKey]);
                    delete countdownIntervals[orderKey];
                    return;
                }
                
                const currentOrder = allOrders[orderIndex];
                const timeRemaining = getTimeRemaining(currentOrder);
                
                // تحديث العرض
                const card = document.querySelector(`.order-card[data-key="${orderKey}"]`);
                if (card) {
                    const prepTimeElement = card.querySelector('.prep-time');
                    if (prepTimeElement) {
                        if (timeRemaining <= 0 && !currentOrder.overdue) {
                            prepTimeElement.classList.add('overdue');
                            markOverdue(orderKey);
                        }
                        
                        let prepTimeText = '';
                        if (typeof timeRemaining === 'number' && !isNaN(timeRemaining)) {
                            if (timeRemaining <= 0) {
                                prepTimeText = `تأخر: ${Math.abs(timeRemaining)} دقيقة`;
                            } else {
                                prepTimeText = `الوقت المتبقي: ${timeRemaining} دقيقة`;
                            }
                        } else {
                            const totalPrepTime = (parseInt(currentOrder.prepTime) || 15) + (parseInt(currentOrder.addedMinutes) || 0);
                            prepTimeText = `التحضير: ${totalPrepTime} دقيقة`;
                        }
                        
                        if (currentOrder.addedMinutes > 0) {
                            prepTimeText += ` (+${currentOrder.addedMinutes})`;
                        }
                        
                        prepTimeElement.innerHTML = `<i class="fas fa-clock"></i> ${prepTimeText}`;
                    }
                }
                
                if (timeRemaining <= 0 && !currentOrder.overdue) {
                    markOverdue(orderKey);
                }
                
            }, 60000);
        }
        
        // إيقاف العد التنازلي
        function stopCountdown(orderKey) {
            if (countdownIntervals[orderKey]) {
                clearInterval(countdownIntervals[orderKey]);
                delete countdownIntervals[orderKey];
            }
        }
        
        // تعليم الطلب كمتأخر
        function markOverdue(orderKey) {
            database.ref('orders/' + orderKey).update({
                overdue: true
            }).then(() => {
                console.log('تم تعليم الطلب كمتأخر');
            }).catch(error => {
                console.error('خطأ في تعليم الطلب كمتأخر:', error);
            });
        }
        
        // عرض تفاصيل الطلب
        function viewOrderDetails(key) {
            const order = allOrders.find(o => o.key === key);
            if (!order) {
                showMessage('الطلب غير موجود', 'error');
                return;
            }
            
            currentOrder = order;
            
            printReceiptBtn.onclick = () => printReceipt(order);
            
            let itemsHTML = '';
            let totalItems = 0;
            if (order.items && order.items.length > 0) {
                itemsHTML = order.items.map(item => {
                    totalItems += parseInt(item.qty) || 1;
                    return `
                        <div class="item-row">
                            <div class="item-info">
                                <div class="item-name">${item.name || 'منتج غير معروف'}</div>
                                ${item.note ? `<div class="item-note">${item.note}</div>` : ''}
                            </div>
                            <div class="item-qty">${item.qty || 1} ×</div>
                        </div>
                    `;
                }).join('');
            } else {
                itemsHTML = '<p style="text-align: center; color: #666;">لا توجد منتجات</p>';
            }
            
            let historyHTML = '';
            if (order.history && order.history.length > 0) {
                historyHTML = order.history.map(entry => `
                    <div style="margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #eee;">
                        <strong>${entry.action === 'accept' ? 'قبول' : 
                                   entry.action === 'ready' ? 'جاهز' : 
                                   entry.action === 'received' ? 'تم الاستلام' :
                                   entry.action === 'add_time' ? `إضافة ${entry.minutes} دقيقة` : 
                                   entry.action}</strong>
                        <div style="font-size: 12px; color: #666;">
                            بواسطة: ${entry.by || 'نظام'} - 
                            ${formatDate(entry.time)}
                        </div>
                    </div>
                `).join('');
            } else {
                historyHTML = '<p style="color: #666;">لا يوجد سجل</p>';
            }
            
            const totalPrepTime = (parseInt(order.prepTime) || 15) + (parseInt(order.addedMinutes) || 0);
            
            orderDetailsBody.innerHTML = `
                <div class="details-grid">
                    <div class="details-card">
                        <h3><i class="fas fa-user"></i> معلومات العميل</h3>
                        <div class="detail-row">
                            <span class="detail-label">الاسم:</span>
                            <span class="detail-value">${order.customerName || 'غير معروف'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">الهاتف:</span>
                            <span class="detail-value">${order.customerPhone || 'لا يوجد'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">نوع الاستلام:</span>
                            <span class="detail-value">${order.orderType === 'توصيل' ? 'توصيل' : 'استلام'}</span>
                        </div>
                        ${order.deliveryArea && order.orderType === 'توصيل' ? `
                        <div class="detail-row">
                            <span class="detail-label">المنطقة:</span>
                            <span class="detail-value">${order.deliveryArea}</span>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="details-card">
                        <h3><i class="fas fa-receipt"></i> تفاصيل الطلب</h3>
                        <div class="detail-row">
                            <span class="detail-label">رقم الطلب:</span>
                            <span class="detail-value">#${order.id || order.key.substring(0, 6)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">تاريخ الطلب:</span>
                            <span class="detail-value">${formatDate(order.timestamp)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">طريقة الدفع:</span>
                            <span class="detail-value">${order.paymentMethod || 'كاش'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">الإجمالي:</span>
                            <span class="detail-value">${order.total || 0} دينار</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">وقت التحضير:</span>
                            <span class="detail-value">${order.prepTime || 15} دقيقة + ${order.addedMinutes || 0} = ${totalPrepTime} دقيقة</span>
                        </div>
                    </div>
                </div>
                
                <div class="order-stats">
                    <div class="stat-item">
                        <i class="fas fa-box"></i>
                        <span>عدد الأصناف: <span class="stat-value">${order.items ? order.items.length : 0}</span></span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-cube"></i>
                        <span>إجمالي القطع: <span class="stat-value">${totalItems}</span></span>
                    </div>
                    <div class="stat-item">
                        <i class="fas fa-clock"></i>
                        <span>الحالة: <span class="stat-value">${order.status === 'pending' ? 'قيد الانتظار' : 
                            order.status === 'accepted' ? 'مقبول' : 
                            order.status === 'ready' ? 'جاهز' : 
                            order.status === 'received' ? 'تم الاستلام' :
                            order.status === 'deleted' ? 'محذوف' :
                            order.status === 'cancelled' ? 'ملغي' :
                            order.status}</span></span>
                    </div>
                </div>
                
                <div class="items-list">
                    <h3><i class="fas fa-shopping-basket"></i> المنتجات (${order.items ? order.items.length : 0})</h3>
                    ${itemsHTML}
                </div>
                
                <div class="details-card" style="margin-top: 20px;">
                    <h3><i class="fas fa-history"></i> سجل الطلب</h3>
                    ${historyHTML}
                </div>
                
                ${order.notes ? `
                <div class="details-card" style="margin-top: 20px;">
                    <h3><i class="fas fa-sticky-note"></i> ملاحظات العميل</h3>
                    <p>${order.notes}</p>
                </div>
                ` : ''}
            `;
            
            orderDetailsModal.style.display = 'flex';
        }
        
        // إغلاق نافذة التفاصيل
        closeModalBtn.addEventListener('click', () => {
            orderDetailsModal.style.display = 'none';
        });
        
        closeDetailsBtn.addEventListener('click', () => {
            orderDetailsModal.style.display = 'none';
        });
        
        orderDetailsModal.addEventListener('click', (e) => {
            if (e.target === orderDetailsModal) {
                orderDetailsModal.style.display = 'none';
            }
        });
        
        // قبول الطلب
        function acceptOrder(key) {
            const updates = {
                status: 'accepted',
                acceptedAt: Date.now()
            };
            
            database.ref('orders/' + key).once('value').then(snapshot => {
                const order = snapshot.val();
                const history = order.history || [];
                history.push({ action: 'accept', by: 'manager', time: Date.now() });
                updates.history = history;
                
                database.ref('orders/' + key).update(updates)
                    .then(() => {
                        showMessage('تم قبول الطلب بنجاح!', 'success');
                        stopRepeatSoundForOrder(key);
                        
                        const orderIndex = allOrders.findIndex(o => o.key === key);
                        if (orderIndex !== -1) {
                            allOrders[orderIndex].status = 'accepted';
                            allOrders[orderIndex].acceptedAt = Date.now();
                            startCountdown(key, allOrders[orderIndex]);
                        }
                    })
                    .catch(error => {
                        showMessage('حدث خطأ أثناء قبول الطلب: ' + error.message, 'error');
                    });
            });
        }
        
        // رفض الطلب
        function rejectOrder(key) {
            if (confirm('هل أنت متأكد من رفض هذا الطلب؟')) {
                database.ref('orders/' + key).update({
                    status: 'cancelled',
                    cancelledAt: Date.now()
                })
                .then(() => {
                    showMessage('تم رفض الطلب بنجاح!', 'success');
                    stopRepeatSoundForOrder(key);
                    stopCountdown(key);
                })
                .catch(error => {
                    showMessage('حدث خطأ أثناء رفض الطلب: ' + error.message, 'error');
                });
            }
        }
        
        // تعليم الطلب كجاهز
        function markAsReady(key) {
            database.ref('orders/' + key).update({
                status: 'ready',
                readyAt: Date.now()
            }).then(() => {
                showMessage('تم تعليم الطلب كجاهز!', 'success');
                stopCountdown(key);
            }).catch(error => {
                showMessage('حدث خطأ أثناء تحديث حالة الطلب: ' + error.message, 'error');
            });
        }
        
        // تعليم الطلب كتم الاستلام
        function markAsReceived(key) {
            if (confirm('هل أنت متأكد من أن الطلب تم استلامه؟')) {
                database.ref('orders/' + key).update({
                    status: 'received',
                    receivedAt: Date.now()
                }).then(() => {
                    showMessage('تم تعليم الطلب كتم الاستلام!', 'success');
                    loadSidebarReceivedOrders(); // تحديث القائمة الجانبية
                }).catch(error => {
                    showMessage('حدث خطأ أثناء تحديث حالة الطلب: ' + error.message, 'error');
                });
            }
        }
        
        // حذف الطلب (نقل للحالة المحذوفة)
        function deleteOrder(key) {
            if (confirm('هل أنت متأكد من حذف هذا الطلب؟')) {
                database.ref('orders/' + key).update({
                    status: 'deleted',
                    deletedAt: Date.now()
                })
                .then(() => {
                    showMessage('تم حذف الطلب بنجاح!', 'success');
                    stopRepeatSoundForOrder(key);
                    stopCountdown(key);
                    
                    // إزالة الطلب من الواجهة فوراً
                    removeOrderFromUI(key);
                    
                    // تحديث القائمة
                    const orderIndex = allOrders.findIndex(o => o.key === key);
                    if (orderIndex !== -1) {
                        allOrders.splice(orderIndex, 1);
                    }
                })
                .catch(error => {
                    showMessage('حدث خطأ أثناء حذف الطلب: ' + error.message, 'error');
                });
            }
        }
        
        // حذف نهائي من قاعدة البيانات
        function permanentDeleteOrder(key) {
            if (confirm('هل أنت متأكد من الحذف النهائي لهذا الطلب؟ لا يمكن التراجع عن هذه العملية.')) {
                database.ref('orders/' + key).remove()
                .then(() => {
                    showMessage('تم الحذف النهائي للطلب!', 'success');
                })
                .catch(error => {
                    showMessage('حدث خطأ أثناء الحذف النهائي: ' + error.message, 'error');
                });
            }
        }
        
        // حذف جميع الطلبات السابقة (من القائمة الجانبية)
        sidebarDeleteAllBtn.addEventListener('click', async () => {
            const password = prompt('أدخل كلمة المرور لحذف جميع الطلبات السابقة:');
            if (password !== '121212') {
                alert('كلمة المرور غير صحيحة');
                return;
            }
            
            if (!confirm('هل أنت متأكد من حذف جميع الطلبات السابقة؟ هذه العملية لا يمكن التراجع عنها.')) {
                return;
            }
            
            try {
                const receivedOrders = allOrders.filter(o => 
                    o.status && 
                    ['received'].includes(o.status) &&
                    o.status !== 'deleted' && 
                    o.status !== 'cancelled'
                );
                
                const updates = {};
                receivedOrders.forEach(order => {
                    updates[order.key + '/status'] = 'deleted';
                    updates[order.key + '/deletedAt'] = Date.now();
                });
                
                if (Object.keys(updates).length === 0) {
                    showMessage('لا توجد طلبات سابقة لحذفها', 'error');
                    return;
                }
                
                await database.ref('orders').update(updates);
                showMessage(`تم حذف ${receivedOrders.length} طلب سابق بنجاح`, 'success');
                sidebar.classList.remove('active');
                
                loadSidebarReceivedOrders(); // تحديث القائمة الجانبية
            } catch (error) {
                showMessage('حدث خطأ أثناء حذف الطلبات السابقة: ' + error.message, 'error');
            }
        });
        
        // تصدير الطلبات السابقة إلى Excel (من القائمة الجانبية)
        sidebarExportBtn.addEventListener('click', async () => {
            try {
                const startTS = new Date(sidebarStartDate.value).getTime();
                const endTS = new Date(sidebarEndDate.value).getTime() + 24 * 60 * 60 * 1000 - 1;
                
                const q = database.ref('orders').orderByChild('timestamp').startAt(startTS).endAt(endTS);
                const snapshot = await q.once('value');
                
                const data = [];
                snapshot.forEach(child => {
                    const order = child.val();
                    if (order.status === 'received' && order.status !== 'deleted' && order.status !== 'cancelled') {
                        let totalItems = 0;
                        let totalQty = 0;
                        if (order.items && order.items.length > 0) {
                            order.items.forEach(item => {
                                totalItems++;
                                totalQty += parseInt(item.qty) || 1;
                            });
                        }
                        
                        data.push({
                            'رقم الطلب': order.id || child.key.substring(0, 6),
                            'اسم العميل': order.customerName || '',
                            'الهاتف': order.customerPhone || '',
                            'نوع الاستلام': order.orderType === 'توصيل' ? 'توصيل' : 'استلام',
                            'المنطقة': order.deliveryArea || '',
                            'طريقة الدفع': order.paymentMethod || '',
                            'الإجمالي': order.total || 0,
                            'عدد الأصناف': totalItems,
                            'إجمالي القطع': totalQty,
                            'الحالة': 'تم الاستلام',
                            'وقت التحضير': (parseInt(order.prepTime) || 15) + (parseInt(order.addedMinutes) || 0) + ' دقيقة',
                            'تاريخ الطلب': formatDateForPrint(order.timestamp),
                            'تاريخ القبول': order.acceptedAt ? formatDateForPrint(order.acceptedAt) : '',
                            'تاريخ الجاهزية': order.readyAt ? formatDateForPrint(order.readyAt) : '',
                            'تاريخ الاستلام': order.receivedAt ? formatDateForPrint(order.receivedAt) : '',
                            'المنتجات': order.items ? order.items.map(item => 
                                `${item.name} (${item.qty})${item.note ? ` - ${item.note}` : ''}`
                            ).join('; ') : '',
                            'ملاحظات العميل': order.notes || ''
                        });
                    }
                });
                
                if (data.length === 0) {
                    showMessage('لا توجد طلبات سابقة للتصدير في النطاق المحدد!', 'error');
                    return;
                }
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "الطلبات السابقة");
                XLSX.writeFile(wb, `طلبات_سابقة_${sidebarStartDate.value}_${sidebarEndDate.value}.xlsx`);
                
                showMessage(`تم تصدير ${data.length} طلب سابق بنجاح!`, 'success');
                sidebar.classList.remove('active');
            } catch (error) {
                showMessage('حدث خطأ أثناء التصدير: ' + error.message, 'error');
            }
        });
        
        // طباعة الفاتورة - الإصدار المعدل
        function printReceipt(order) {
            try {
                // تحديث بيانات الفاتورة
                document.getElementById('receiptOrderId').textContent = `الطلب: #${order.id || order.key.substring(0, 6)}`;
                document.getElementById('receiptDate').textContent = `التاريخ: ${formatDateForPrint(order.timestamp)}`;
                document.getElementById('receiptCustomerName').textContent = `العميل: ${order.customerName || 'غير معروف'}`;
                document.getElementById('receiptCustomerPhone').textContent = `الهاتف: ${order.customerPhone || 'لا يوجد'}`;
                document.getElementById('receiptPickupType').textContent = order.orderType === 'توصيل' ? 'توصيل' : 'استلام';
                document.getElementById('receiptPayment').textContent = `الدفع: ${order.paymentMethod || 'كاش'}`;
                document.getElementById('receiptTotal').textContent = `الإجمالي: ${order.total || 0} دينار`;
                document.getElementById('receiptPrintDate').textContent = formatDateForPrint(Date.now());
                
                // تحديث المنتجات
                const receiptItemsBody = document.getElementById('receiptItemsBody');
                receiptItemsBody.innerHTML = '';
                
                if (order.items && order.items.length > 0) {
                    order.items.forEach(item => {
                        const qty = parseInt(item.qty) || 1;
                        
                        const row = document.createElement('tr');
                        if (item.note) {
                            row.innerHTML = `
                                <td>
                                    ${item.name || 'منتج غير معروف'}
                                    <div style="font-size: 8pt; color: #666; font-style: italic; margin-top: 2px;">
                                        ${item.note}
                                    </div>
                                </td>
                                <td style="text-align: center;">${qty}</td>
                            `;
                        } else {
                            row.innerHTML = `
                                <td>${item.name || 'منتج غير معروف'}</td>
                                <td style="text-align: center;">${qty}</td>
                            `;
                        }
                        receiptItemsBody.appendChild(row);
                    });
                } else {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="2" style="text-align: center; padding: 10px 0;">لا توجد منتجات</td>
                    `;
                    receiptItemsBody.appendChild(row);
                }
                
                // إعداد الطباعة
                const receipt = document.getElementById('receipt');
                const printContent = receipt.innerHTML;
                const originalContent = document.body.innerHTML;
                
                // فتح نافذة طباعة
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                
                // كتابة محتوى الفاتورة في النافذة الجديدة
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl" lang="ar">
                    <head>
                        <meta charset="UTF-8">
                        <title>طباعة الفاتورة</title>
                        <style>
                            @media print {
                                body { 
                                    font-family: 'Courier New', monospace !important; 
                                    width: 80mm !important; 
                                    margin: 0 !important; 
                                    padding: 0 !important; 
                                    font-size: 10pt !important; 
                                    color: black !important; 
                                    background: white !important;
                                    line-height: 1.2 !important;
                                }
                                * { 
                                    box-sizing: border-box !important;
                                }
                                .receipt-header { 
                                    text-align: center; 
                                    margin-bottom: 8px; 
                                    border-bottom: 1px dashed #000; 
                                    padding-bottom: 8px;
                                }
                                .receipt-header h2 { 
                                    font-size: 14pt; 
                                    margin: 0; 
                                    color: black;
                                }
                                .receipt-info { 
                                    font-size: 9pt; 
                                    margin: 8px 0; 
                                }
                                table { 
                                    width: 100% !important; 
                                    border-collapse: collapse !important; 
                                    margin: 10px 0 !important; 
                                    font-size: 9pt !important; 
                                }
                                th { 
                                    text-align: right !important; 
                                    border-bottom: 2px solid #000 !important; 
                                    padding: 8px 0 !important; 
                                    font-weight: bold !important; 
                                }
                                td { 
                                    text-align: right !important; 
                                    border-bottom: 1px dashed #ccc !important; 
                                    padding: 6px 0 !important; 
                                }
                                .receipt-total { 
                                    font-weight: bold !important; 
                                    font-size: 11pt !important; 
                                    text-align: center !important; 
                                    margin-top: 15px !important; 
                                    padding-top: 10px !important; 
                                    border-top: 2px solid #000 !important; 
                                }
                                .receipt-footer { 
                                    text-align: center !important; 
                                    margin-top: 15px !important; 
                                    font-size: 8pt !important; 
                                    color: #666 !important; 
                                }
                                hr { 
                                    border: none !important; 
                                    border-top: 1px dashed #000 !important; 
                                    margin: 8px 0 !important; 
                                }
                            }
                            @page {
                                margin: 0;
                                size: 80mm auto;
                            }
                        </style>
                    </head>
                    <body onload="window.print(); window.close();">
                        ${printContent}
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
                
            } catch (error) {
                console.error('خطأ في طباعة الفاتورة:', error);
                showMessage('حدث خطأ أثناء طباعة الفاتورة: ' + error.message, 'error');
            }
        }
        
        // طباعة الطلب
        function printOrder(key) {
            const order = allOrders.find(o => o.key === key);
            if (order) {
                printReceipt(order);
            }
        }
        
        // عرض رسالة
        function showMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.style.position = 'fixed';
            messageDiv.style.top = '20px';
            messageDiv.style.left = '50%';
            messageDiv.style.transform = 'translateX(-50%)';
            messageDiv.style.padding = '15px 25px';
            messageDiv.style.borderRadius = '8px';
            messageDiv.style.color = 'white';
            messageDiv.style.fontWeight = 'bold';
            messageDiv.style.zIndex = '3000';
            messageDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            
            if (type === 'success') {
                messageDiv.style.background = '#43a047';
            } else if (type === 'error') {
                messageDiv.style.background = '#e53935';
            } else {
                messageDiv.style.background = '#2196f3';
            }
            
            messageDiv.textContent = text;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.opacity = '0';
                messageDiv.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(messageDiv);
                }, 500);
            }, 3000);
        }
        
        // تصفية البحث
        function filterOrders() {
            const searchTerm = sidebarSearchInput.value.toLowerCase();
            const startTS = sidebarStartDate.value ? new Date(sidebarStartDate.value).getTime() : null;
            const endTS = sidebarEndDate.value ? new Date(sidebarEndDate.value).getTime() + 24 * 60 * 60 * 1000 - 1 : null;
            
            updateOrdersUI(searchTerm, startTS, endTS);
        }
        
        // ربط أحداث القائمة الجانبية
        sidebarFilterBtn.addEventListener('click', sidebarFilterOrders);
        sidebarClearFilterBtn.addEventListener('click', () => {
            sidebarSearchInput.value = '';
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            sidebarStartDate.valueAsDate = lastWeek;
            sidebarEndDate.valueAsDate = today;
            updateOrdersUI();
            loadSidebarReceivedOrders();
        });
        
        // تحديث العداد في التبويبات
        function updateTabCounters() {
            const newOrders = allOrders.filter(o => 
                (!o.status || o.status === 'pending') && 
                o.status !== 'deleted' && 
                o.status !== 'cancelled'
            );
            const acceptedOrders = allOrders.filter(o => 
                o.status && 
                ['accepted'].includes(o.status) &&
                o.status !== 'deleted' && 
                o.status !== 'cancelled'
            );
            const readyOrders = allOrders.filter(o => 
                o.status && 
                ['ready'].includes(o.status) &&
                o.status !== 'deleted' && 
                o.status !== 'cancelled'
            );
            const receivedOrders = allOrders.filter(o => 
                o.status && 
                ['received'].includes(o.status) &&
                o.status !== 'deleted' && 
                o.status !== 'cancelled'
            );
            
            newOrdersTabCount.textContent = newOrders.length;
            acceptedOrdersTabCount.textContent = acceptedOrders.length;
            readyOrdersTabCount.textContent = readyOrders.length;
            sidebarReceivedCount.textContent = receivedOrders.length;
        }
        
        // تحديث واجهة الطلبات مع التصفية
        function updateOrdersUI(searchTerm = '', startTS = null, endTS = null) {
            // تصفية الطلبات
            let filteredOrders = allOrders.filter(order => {
                if (order.status === 'deleted' || order.status === 'cancelled') return false;
                
                // تصفية حسب النص
                if (searchTerm) {
                    const matchesName = order.customerName && 
                        order.customerName.toLowerCase().includes(searchTerm);
                    const matchesPhone = order.customerPhone && 
                        order.customerPhone.includes(searchTerm);
                    const matchesId = (order.id || order.key).toLowerCase().includes(searchTerm);
                    
                    if (!matchesName && !matchesPhone && !matchesId) return false;
                }
                
                // تصفية حسب التاريخ
                if (startTS && order.timestamp < startTS) return false;
                if (endTS && order.timestamp > endTS) return false;
                
                return true;
            });
            
            // فصل الطلبات حسب الحالة
            const newOrders = filteredOrders.filter(o => !o.status || o.status === 'pending');
            const acceptedOrders = filteredOrders.filter(o => 
                o.status && ['accepted'].includes(o.status)
            );
            const readyOrders = filteredOrders.filter(o => 
                o.status && ['ready'].includes(o.status)
            );
            
            // فرز الطلبات حسب التاريخ (الأحدث أولاً)
            newOrders.sort((a, b) => b.timestamp - a.timestamp);
            acceptedOrders.sort((a, b) => b.timestamp - a.timestamp);
            readyOrders.sort((a, b) => b.timestamp - a.timestamp);
            
            // عرض الطلبات الجديدة
            const newOrdersFragment = document.createDocumentFragment();
            
            if (newOrders.length === 0) {
                newOrdersContainer.innerHTML = `
                    <div class="no-orders">
                        <i class="fas fa-inbox"></i>
                        <h3>لا توجد طلبات جديدة</h3>
                        <p>في انتظار وصول الطلبات الجديدة...</p>
                    </div>
                `;
            } else {
                newOrders.forEach(order => {
                    const card = createOrderCard(order, true);
                    newOrdersFragment.appendChild(card);
                });
                newOrdersContainer.innerHTML = '';
                newOrdersContainer.appendChild(newOrdersFragment);
            }
            
            // عرض الطلبات المقبولة
            const acceptedOrdersFragment = document.createDocumentFragment();
            
            if (acceptedOrders.length === 0) {
                acceptedOrdersContainer.innerHTML = `
                    <div class="no-orders">
                        <i class="fas fa-clipboard-check"></i>
                        <h3>لا توجد طلبات مقبولة</h3>
                        <p>سيظهر هنا الطلبات التي تم قبولها...</p>
                    </div>
                `;
            } else {
                acceptedOrders.forEach(order => {
                    const card = createOrderCard(order, false);
                    acceptedOrdersFragment.appendChild(card);
                    
                    if (order.status === 'accepted' && !countdownIntervals[order.key]) {
                        startCountdown(order.key, order);
                    }
                });
                acceptedOrdersContainer.innerHTML = '';
                acceptedOrdersContainer.appendChild(acceptedOrdersFragment);
            }
            
            // عرض الطلبات الجاهزة
            const readyOrdersFragment = document.createDocumentFragment();
            
            if (readyOrders.length === 0) {
                readyOrdersContainer.innerHTML = `
                    <div class="no-orders">
                        <i class="fas fa-check-double"></i>
                        <h3>لا توجد طلبات جاهزة</h3>
                        <p>سيظهر هنا الطلبات التي أصبحت جاهزة...</p>
                    </div>
                `;
            } else {
                readyOrders.forEach(order => {
                    const card = createOrderCard(order, false);
                    readyOrdersFragment.appendChild(card);
                });
                readyOrdersContainer.innerHTML = '';
                readyOrdersContainer.appendChild(readyOrdersFragment);
            }
            
            // تحديث العدادات
            updateTabCounters();
        }
        
        // إدارة كروت الطلبات
        const orderCards = new Map();
        
        function addOrderToUI(order, isNewOrder = false) {
            const isNew = !order.status || order.status === 'pending';
            const card = createOrderCard(order, isNew);
            
            if (isNew && order.status !== 'deleted' && order.status !== 'cancelled') {
                const container = document.getElementById('newOrders');
                const noOrdersMsg = container.querySelector('.no-orders');
                if (noOrdersMsg) {
                    container.innerHTML = '';
                }
                container.prepend(card);
                
                if (isNewOrder) {
                    showNotification(order.key);
                }
            } else if (order.status === 'accepted' && order.status !== 'deleted' && order.status !== 'cancelled') {
                const container = document.getElementById('acceptedOrders');
                const noOrdersMsg = container.querySelector('.no-orders');
                if (noOrdersMsg) {
                    container.innerHTML = '';
                }
                container.prepend(card);
                
                startCountdown(order.key, order);
            } else if (order.status === 'ready' && order.status !== 'deleted' && order.status !== 'cancelled') {
                const container = document.getElementById('readyOrders');
                const noOrdersMsg = container.querySelector('.no-orders');
                if (noOrdersMsg) {
                    container.innerHTML = '';
                }
                container.prepend(card);
            }
            
            orderCards.set(order.key, { card, isNew });
            updateTabCounters();
            
            // تحديث الطلبات السابقة في القائمة الجانبية
            if (order.status === 'received') {
                loadSidebarReceivedOrders();
            }
        }
        
        function updateOrderInUI(order) {
            // إذا كان الطلب محذوفاً أو ملغياً، قم بإزالته من الواجهة
            if (order.status === 'deleted' || order.status === 'cancelled') {
                removeOrderFromUI(order.key);
                return;
            }
            
            const existing = orderCards.get(order.key);
            if (!existing) {
                addOrderToUI(order);
                return;
            }
            
            const newIsNew = !order.status || order.status === 'pending';
            const isAccepted = order.status === 'accepted';
            const isReady = order.status === 'ready';
            const isReceived = order.status === 'received';
            
            // تحديد المكان الجديد للطلب
            let newContainer;
            if (newIsNew) {
                newContainer = 'newOrders';
            } else if (isAccepted) {
                newContainer = 'acceptedOrders';
            } else if (isReady) {
                newContainer = 'readyOrders';
            } else if (isReceived) {
                // الطلبات المستلمة لا تظهر في التبويبات الرئيسية
                removeOrderFromUI(order.key);
                loadSidebarReceivedOrders();
                return;
            }
            
            const oldContainer = existing.isNew ? 'newOrders' : 
                (existing.card.parentNode && existing.card.parentNode.id === 'acceptedOrders' ? 'acceptedOrders' : 'readyOrders');
            
            if (oldContainer !== newContainer) {
                removeOrderFromUI(order.key);
                addOrderToUI(order);
            } else {
                const container = document.getElementById(newContainer);
                
                const newCard = createOrderCard(order, newIsNew);
                const oldCard = existing.card;
                if (oldCard && oldCard.parentNode === container) {
                    container.replaceChild(newCard, oldCard);
                }
                
                orderCards.set(order.key, { card: newCard, isNew: newIsNew });
                
                if (order.status === 'accepted' && !existing.isNew) {
                    startCountdown(order.key, order);
                } else if (order.status !== 'accepted') {
                    stopCountdown(order.key);
                }
            }
            
            // تحديث الطلبات السابقة في القائمة الجانبية
            if (order.status === 'received') {
                loadSidebarReceivedOrders();
            }
        }
        
        function removeOrderFromUI(orderKey) {
            const existing = orderCards.get(orderKey);
            if (existing) {
                const container = existing.isNew ? 
                    document.getElementById('newOrders') : 
                    (existing.card.parentNode && existing.card.parentNode.id === 'acceptedOrders' ? 
                     document.getElementById('acceptedOrders') : document.getElementById('readyOrders'));
                
                if (existing.card && existing.card.parentNode === container) {
                    container.removeChild(existing.card);
                }
                
                orderCards.delete(orderKey);
                updateTabCounters();
                
                stopRepeatSoundForOrder(orderKey);
                stopCountdown(orderKey);
            }
            
            // إذا أصبحت القائمة فارغة، عرض رسالة عدم وجود طلبات
            const newContainer = document.getElementById('newOrders');
            const acceptedContainer = document.getElementById('acceptedOrders');
            const readyContainer = document.getElementById('readyOrders');
            
            if (newContainer.children.length === 0) {
                newContainer.innerHTML = `
                    <div class="no-orders">
                        <i class="fas fa-inbox"></i>
                        <h3>لا توجد طلبات جديدة</h3>
                        <p>في انتظار وصول الطلبات الجديدة...</p>
                    </div>
                `;
            }
            
            if (acceptedContainer.children.length === 0) {
                acceptedContainer.innerHTML = `
                    <div class="no-orders">
                        <i class="fas fa-clipboard-check"></i>
                        <h3>لا توجد طلبات مقبولة</h3>
                        <p>سيظهر هنا الطلبات التي تم قبولها...</p>
                    </div>
                `;
            }
            
            if (readyContainer.children.length === 0) {
                readyContainer.innerHTML = `
                    <div class="no-orders">
                        <i class="fas fa-check-double"></i>
                        <h3>لا توجد طلبات جاهزة</h3>
                        <p>سيظهر هنا الطلبات التي أصبحت جاهزة...</p>
                    </div>
                `;
            }
            
            // تحديث الطلبات السابقة في القائمة الجانبية
            loadSidebarReceivedOrders();
        }
        
        // الاستماع للتغييرات في قاعدة البيانات
        function listenForOrders() {
            const ordersRef = database.ref('orders').orderByChild('timestamp');
            
            ordersRef.on('child_added', (snapshot) => {
                const order = snapshot.val();
                if (!order) return;
                
                order.key = snapshot.key;
                order.prepTime = parseInt(order.prepTime) || 15;
                
                allOrders.push(order);
                addOrderToUI(order, true);
            }, (error) => {
                console.error('خطأ في child_added:', error);
                showMessage('خطأ في تحميل الطلبات الجديدة', 'error');
            });
            
            ordersRef.on('child_changed', (snapshot) => {
                const order = snapshot.val();
                if (!order) return;
                
                order.key = snapshot.key;
                order.prepTime = parseInt(order.prepTime) || 15;
                
                const index = allOrders.findIndex(o => o.key === order.key);
                if (index !== -1) {
                    allOrders[index] = order;
                } else {
                    allOrders.push(order);
                }
                
                updateOrderInUI(order);
            }, (error) => {
                console.error('خطأ في child_changed:', error);
                showMessage('خطأ في تحديث الطلب', 'error');
            });
            
            ordersRef.on('child_removed', (snapshot) => {
                const orderKey = snapshot.key;
                allOrders = allOrders.filter(o => o.key !== orderKey);
                removeOrderFromUI(orderKey);
                loadSidebarReceivedOrders();
            }, (error) => {
                console.error('خطأ في child_removed:', error);
                showMessage('خطأ في حذف الطلب', 'error');
            });
        }
        
        // بدء التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            initAudio();
            updateSoundUI();
            listenForOrders();
            
            // تحديث العدادات كل دقيقة
            setInterval(updateTabCounters, 60000);
            
            // تحديث جميع العدادات التنازلية كل 30 ثانية
            setInterval(() => {
                allOrders.forEach(order => {
                    if (order.status === 'accepted' && countdownIntervals[order.key]) {
                        const card = document.querySelector(`.order-card[data-key="${order.key}"]`);
                        if (card) {
                            const timeRemaining = getTimeRemaining(order);
                            const prepTimeElement = card.querySelector('.prep-time');
                            if (prepTimeElement) {
                                let prepTimeText = '';
                                if (typeof timeRemaining === 'number' && !isNaN(timeRemaining)) {
                                    if (timeRemaining <= 0) {
                                        prepTimeText = `تأخر: ${Math.abs(timeRemaining)} دقيقة`;
                                        if (!order.overdue) {
                                            prepTimeElement.classList.add('overdue');
                                        }
                                    } else {
                                        prepTimeText = `الوقت المتبقي: ${timeRemaining} دقيقة`;
                                    }
                                } else {
                                    const totalPrepTime = (parseInt(order.prepTime) || 15) + (parseInt(order.addedMinutes) || 0);
                                    prepTimeText = `التحضير: ${totalPrepTime} دقيقة`;
                                }
                                
                                if (order.addedMinutes > 0) {
                                    prepTimeText += ` (+${order.addedMinutes})`;
                                }
                                
                                prepTimeElement.innerHTML = `<i class="fas fa-clock"></i> ${prepTimeText}`;
                            }
                        }
                    }
                });
            }, 30000);
        });
    </script>
</body>
</html>
